input {
    dead_letter_queue {
        path => "${LOGSTASH_HOME}/data/dead_letter_queue"
        commit_offsets => true
        pipeline_id => "main"
    }
}
filter {
  # Capture the failed event safely inside an allowed field
  ruby {
    code => "
      # Serialize the entire failed event into the 'description' field
      event.set('description', 'Failed event: ' + event.to_json)

      # Add a few safe, permitted fields
      event.set('last_modified', LogStash::Timestamp.now.time)
      event.set('pipeline', event.get('[@metadata][dead_letter_queue][pipeline_id]') || 'main')
      event.set('username', 'logstash')
    "
  }

  # Remove everything else so only allowed fields remain
  prune {
    whitelist_names => [
      '^description$',
      '^last_modified$',
      '^pipeline$',
      '^username$'
    ]
  }
}
output {
    elasticsearch {
        hosts => ["${ES_HOSTS}"]
        sniffing => false
        index => ".logstash_dead_letter"
    }
}
